<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISION - Crowd Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-disconnected {
            background: #ef4444;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input, .controls select, .controls button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .controls button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        .controls button.active {
            background: #10b981;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .risk-normal { color: #10b981; }
        .risk-warning { color: #f59e0b; }
        .risk-critical { color: #ef4444; }

        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }

        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .video-container:hover .video-controls {
            opacity: 1;
        }

        .video-controls button {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .alerts-panel {
            max-height: 500px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .alert-item:hover {
            transform: translateX(5px);
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .alert-item.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .camera-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .camera-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .camera-card.active {
            border: 3px solid #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .zone-editor {
            margin-top: 20px;
        }

        .zone-list {
            margin-top: 20px;
        }

        .zone-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .movement-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .time-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-range-selector button {
            padding: 8px 15px;
            background: #f3f4f6;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .time-range-selector button.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• VISION - Crowd Monitoring Dashboard</h1>
            <div class="header-controls">
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">Connecting...</span>
                <span id="wsStatus" style="margin-left: 20px; font-size: 12px; color: #666;"></span>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="apiUrl" placeholder="API URL" value="http://localhost:8000" style="flex: 1; min-width: 200px;">
            <select id="cameraSelect">
                <option value="">Select Camera...</option>
            </select>
            <button onclick="loadCameras()">Refresh Cameras</button>
            <button id="autoRefreshBtn" onclick="toggleAutoRefresh()">Start Auto-Refresh</button>
            <span id="lastUpdate" style="margin-left: auto; color: #666; font-size: 12px;"></span>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-button" onclick="switchTab('analytics')">Analytics</button>
            <button class="tab-button" onclick="switchTab('zones')">Zones</button>
            <button class="tab-button" onclick="switchTab('alerts')">Alerts</button>
            <button class="tab-button" onclick="switchTab('cross-camera')">Cross-Camera</button>
        </div>

        <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìä Real-time Metrics</h2>
                    <div id="metricsContent">
                        <div class="loading">Loading metrics...</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üë• Detection Summary</h2>
                    <div id="detectionContent">
                        <div class="loading">Loading detections...</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üö™ Entry/Exit Logs</h2>
                    <div id="entryExitContent">
                        <div class="loading">Loading entry/exit data...</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div>
                    <div class="card">
                        <h2>üìπ Live Stream</h2>
                        <div class="video-container" id="videoContainer">
                            <img id="videoStream" src="" alt="Camera Stream" style="display: none;">
                            <div id="streamPlaceholder" style="padding: 100px; text-align: center; color: #666;">
                                Select a camera to view stream
                            </div>
                            <div class="video-controls">
                                <button onclick="toggleStream()">‚è∏Ô∏è Pause</button>
                                <button onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                                <button onclick="captureSnapshot()">üì∑ Snapshot</button>
                                <label style="color: white; margin-left: auto;">
                                    <input type="checkbox" id="showHeatmap" onchange="updateStreamParams()"> Heatmap
                                </label>
                                <label style="color: white;">
                                    <input type="checkbox" id="showZones" checked onchange="updateStreamParams()"> Zones
                                </label>
                                <label style="color: white;">
                                    <input type="checkbox" id="showTrackIds" checked onchange="updateStreamParams()"> Track IDs
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card alerts-panel">
                        <h2>‚ö†Ô∏è Active Alerts</h2>
                        <div id="alertsContent">
                            <div class="loading">Loading alerts...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>üì∑ Available Cameras</h2>
                <div class="camera-grid" id="cameraListContent">
                    <div class="loading">Loading cameras...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content">
            <div class="card">
                <h2>üìà Historical Analytics</h2>
                <div class="time-range-selector">
                    <button onclick="setTimeRange(1)" class="active">Last Hour</button>
                    <button onclick="setTimeRange(6)">Last 6 Hours</button>
                    <button onclick="setTimeRange(24)">Last 24 Hours</button>
                    <button onclick="setTimeRange(168)">Last Week</button>
                </div>
                <div class="chart-container">
                    <canvas id="peopleCountChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="densityChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Zones Tab -->
        <div id="zonesTab" class="tab-content">
            <div class="card">
                <h2>üìç Zone Management</h2>
                <div style="margin-bottom: 20px;">
                    <select id="zoneCameraSelect">
                        <option value="">Select Camera...</option>
                    </select>
                    <button onclick="createZone()" style="margin-left: 10px;">Create Zone</button>
                </div>
                <div id="zonesContent">
                    <div class="loading">Select a camera to manage zones</div>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alertsTab" class="tab-content">
            <div class="card">
                <h2>üö® Alert Management</h2>
                <div style="margin-bottom: 20px;">
                    <select id="alertFilter">
                        <option value="all">All Alerts</option>
                        <option value="active">Active Only</option>
                        <option value="warning">Warnings</option>
                        <option value="critical">Critical</option>
                    </select>
                    <button onclick="loadAlerts()" style="margin-left: 10px;">Refresh</button>
                </div>
                <div class="alerts-panel" id="allAlertsContent">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>
        </div>

        <!-- Cross-Camera Tab -->
        <div id="crossCameraTab" class="tab-content">
            <div class="card">
                <h2>üîÑ Cross-Camera Movements</h2>
                <div style="margin-bottom: 20px;">
                    <select id="movementCamera1">
                        <option value="">Entry Camera...</option>
                    </select>
                    <select id="movementCamera2">
                        <option value="">Exit Camera...</option>
                    </select>
                    <button onclick="loadCrossCameraMovements()">Load Movements</button>
                </div>
                <div id="movementsContent">
                    <div class="loading">Select cameras to view cross-camera movements</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone Creation Modal -->
    <div id="zoneModal" class="modal">
        <div class="modal-content">
            <h2>Create Zone</h2>
            <form id="zoneForm" onsubmit="saveZone(event)">
                <input type="text" id="zoneName" placeholder="Zone Name" required style="width: 100%; margin-bottom: 10px; padding: 10px;">
                <select id="zoneType" required style="width: 100%; margin-bottom: 10px; padding: 10px;">
                    <option value="monitor">Monitor</option>
                    <option value="entry">Entry</option>
                    <option value="exit">Exit</option>
                    <option value="restricted">Restricted</option>
                </select>
                <input type="number" id="zoneCapacity" placeholder="Max Capacity (optional)" style="width: 100%; margin-bottom: 10px; padding: 10px;">
                <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                    Note: Zone polygon coordinates will be set via API after drawing on video stream
                </p>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1;">Create Zone</button>
                    <button type="button" onclick="closeZoneModal()" style="flex: 1; background: #ef4444;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let autoRefreshInterval = null;
        let selectedCameraId = null;
        let currentTab = 'overview';
        let timeRangeHours = 1;
        let socket = null;
        let metricsSocket = null;
        let alertsSocket = null;
        let streamPaused = false;
        let charts = {};

        const API_BASE_URL = 'http://localhost:8000';

        // Initialize
        document.getElementById('apiUrl').value = API_BASE_URL;
        updateConnectionStatus(false);
        loadCameras();
        initializeWebSockets();
        startAutoRefresh();

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'Disconnected';
            }
        }

        function initializeWebSockets() {
            const apiUrl = document.getElementById('apiUrl').value.replace('http://', 'ws://').replace('https://', 'wss://');
            
            // Connect to alerts stream
            try {
                alertsSocket = io(`${apiUrl.replace('ws://', 'http://').replace('wss://', 'https://')}`, {
                    transports: ['websocket', 'polling']
                });

                alertsSocket.on('connect', () => {
                    document.getElementById('wsStatus').textContent = 'WS: Connected';
                    alertsSocket.emit('subscribe', 'alerts');
                });

                alertsSocket.on('alert', (data) => {
                    if (data.type === 'alert') {
                        addAlertToPanel(data.alert);
                    }
                });

                alertsSocket.on('disconnect', () => {
                    document.getElementById('wsStatus').textContent = 'WS: Disconnected';
                });
            } catch (error) {
                console.error('WebSocket connection error:', error);
            }
        }

        function connectMetricsWebSocket(cameraId) {
            if (!cameraId) return;
            
            const apiUrl = document.getElementById('apiUrl').value.replace('http://', 'ws://').replace('https://', 'wss://');
            
            // Disconnect existing connection
            if (metricsSocket) {
                metricsSocket.disconnect();
            }

            try {
                metricsSocket = io(`${apiUrl.replace('ws://', 'http://').replace('wss://', 'https://')}`, {
                    transports: ['websocket', 'polling']
                });

                metricsSocket.on('connect', () => {
                    metricsSocket.emit('subscribe', `dashboard/${cameraId}`);
                });

                metricsSocket.on('metrics', (data) => {
                    if (data.type === 'metrics' && data.camera_id === cameraId) {
                        updateMetricsDisplay(data.data);
                    }
                });
            } catch (error) {
                console.error('Metrics WebSocket error:', error);
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'analytics') {
                loadHistoricalAnalytics();
            } else if (tabName === 'zones') {
                loadZones();
            } else if (tabName === 'cross-camera') {
                loadCrossCameraMovements();
            }
        }

        function setTimeRange(hours) {
            timeRangeHours = hours;
            document.querySelectorAll('.time-range-selector button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadHistoricalAnalytics();
        }

        async function loadCameras() {
            const apiUrl = document.getElementById('apiUrl').value;
            const select = document.getElementById('cameraSelect');
            const zoneSelect = document.getElementById('zoneCameraSelect');
            const movementSelect1 = document.getElementById('movementCamera1');
            const movementSelect2 = document.getElementById('movementCamera2');
            const listContent = document.getElementById('cameraListContent');

            try {
                const response = await fetch(`${apiUrl}/api/v1/cameras`);
                const data = await response.json();
                
                updateConnectionStatus(true);

                // Update all selects
                [select, zoneSelect, movementSelect1, movementSelect2].forEach(sel => {
                    sel.innerHTML = '<option value="">Select Camera...</option>';
                    data.cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.camera_id;
                        option.textContent = `${camera.camera_id} - ${camera.location || 'Unknown'}`;
                        sel.appendChild(option);
                    });
                });

                // Update camera grid
                if (data.cameras.length === 0) {
                    listContent.innerHTML = '<div class="loading">No cameras registered</div>';
                } else {
                    listContent.innerHTML = data.cameras.map(camera => `
                        <div class="camera-card ${selectedCameraId === camera.camera_id ? 'active' : ''}" 
                             onclick="selectCamera('${camera.camera_id}')">
                            <h3>${camera.camera_id}</h3>
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                                ${camera.location || 'No location'}
                            </p>
                            <p style="color: #666; font-size: 12px;">
                                Status: <span class="${camera.status === 'active' ? 'status-active' : 'status-inactive'}">${camera.status}</span>
                            </p>
                        </div>
                    `).join('');
                }

                if (!selectedCameraId && data.cameras.length > 0) {
                    selectCamera(data.cameras[0].camera_id);
                }
            } catch (error) {
                updateConnectionStatus(false);
                listContent.innerHTML = `<div class="error">Error loading cameras: ${error.message}</div>`;
                console.error('Error loading cameras:', error);
            }
        }

        function selectCamera(cameraId) {
            selectedCameraId = cameraId;
            document.getElementById('cameraSelect').value = cameraId;
            document.getElementById('zoneCameraSelect').value = cameraId;
            
            // Update active state
            document.querySelectorAll('.camera-card').forEach(card => {
                card.classList.remove('active');
                if (card.textContent.includes(cameraId)) {
                    card.classList.add('active');
                }
            });

            // Load data and connect WebSocket
            loadMetrics();
            loadDetection();
            loadEntryExit();
            loadAlerts();
            updateVideoStream();
            connectMetricsWebSocket(cameraId);
            
            if (currentTab === 'analytics') {
                loadHistoricalAnalytics();
            } else if (currentTab === 'zones') {
                loadZones();
            }
        }

        document.getElementById('cameraSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                selectCamera(e.target.value);
            }
        });

        async function loadMetrics() {
            if (!selectedCameraId) return;

            const apiUrl = document.getElementById('apiUrl').value;
            const content = document.getElementById('metricsContent');

            try {
                const response = await fetch(`${apiUrl}/api/v1/analytics/${selectedCameraId}/realtime`);
                const data = await response.json();

                const riskClass = `risk-${data.risk_level.toLowerCase()}`;

                content.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">People Count</span>
                        <span class="metric-value">${data.people_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Density</span>
                        <span class="metric-value">${((data.density || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Average Speed</span>
                        <span class="metric-value">${(data.avg_speed || 0).toFixed(1)} px/s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Congestion</span>
                        <span class="metric-value">${data.congestion_level || 'low'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Risk Level</span>
                        <span class="metric-value ${riskClass}">${data.risk_level || 'NORMAL'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Risk Score</span>
                        <span class="metric-value ${riskClass}">${(data.risk_score || 0).toFixed(2)}</span>
                    </div>
                `;

                updateLastUpdateTime();
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading metrics: ${error.message}</div>`;
                console.error('Error loading metrics:', error);
            }
        }

        function updateMetricsDisplay(data) {
            const content = document.getElementById('metricsContent');
            const riskClass = `risk-${data.risk_level.toLowerCase()}`;

            content.innerHTML = `
                <div class="metric">
                    <span class="metric-label">People Count</span>
                    <span class="metric-value">${data.people_count || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Density</span>
                    <span class="metric-value">${((data.density || 0) * 100).toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Speed</span>
                    <span class="metric-value">${(data.avg_speed || 0).toFixed(1)} px/s</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Congestion</span>
                    <span class="metric-value">${data.congestion_level || 'low'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Risk Level</span>
                    <span class="metric-value ${riskClass}">${data.risk_level || 'NORMAL'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Risk Score</span>
                    <span class="metric-value ${riskClass}">${(data.risk_score || 0).toFixed(2)}</span>
                </div>
            `;
        }

        async function loadDetection() {
            if (!selectedCameraId) return;

            const apiUrl = document.getElementById('apiUrl').value;
            const content = document.getElementById('detectionContent');

            try {
                const response = await fetch(`${apiUrl}/api/v1/analytics/${selectedCameraId}/realtime`);
                const data = await response.json();

                content.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Detections</span>
                        <span class="metric-value">${data.people_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Tracks</span>
                        <span class="metric-value">${data.people_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last Update</span>
                        <span class="metric-value" style="font-size: 14px;">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading detection data: ${error.message}</div>`;
                console.error('Error loading detection:', error);
            }
        }

        async function loadEntryExit() {
            if (!selectedCameraId) return;

            const apiUrl = document.getElementById('apiUrl').value;
            const content = document.getElementById('entryExitContent');

            try {
                // Get entry/exit logs
                const response = await fetch(`${apiUrl}/api/v1/analytics/${selectedCameraId}/entry-exit?limit=10`);
                const data = await response.json();

                if (data.entry_exit_logs && data.entry_exit_logs.length > 0) {
                    content.innerHTML = data.entry_exit_logs.map(log => `
                        <div class="metric">
                            <span class="metric-label">${log.event_type.toUpperCase()} - Track ${log.track_id}</span>
                            <span class="metric-value" style="font-size: 14px;">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="loading">No entry/exit events</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading entry/exit data: ${error.message}</div>`;
                console.error('Error loading entry/exit:', error);
            }
        }

        async function loadAlerts() {
            const apiUrl = document.getElementById('apiUrl').value;
            const filter = document.getElementById('alertFilter')?.value || 'active';
            const content = currentTab === 'alerts' ? document.getElementById('allAlertsContent') : document.getElementById('alertsContent');

            try {
                let url = `${apiUrl}/api/v1/alerts/active?limit=50`;
                if (selectedCameraId && filter === 'active') {
                    url += `&camera_id=${selectedCameraId}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                let alerts = data.alerts || [];
                
                // Apply filters
                if (filter === 'warning') {
                    alerts = alerts.filter(a => a.severity === 'WARNING');
                } else if (filter === 'critical') {
                    alerts = alerts.filter(a => a.severity === 'CRITICAL');
                }

                if (alerts.length > 0) {
                    content.innerHTML = alerts.map(alert => {
                        const alertClass = alert.severity.toLowerCase();
                        return `
                            <div class="alert-item ${alertClass}" onclick="acknowledgeAlert(${alert.id})">
                                <div class="alert-header">
                                    <span class="alert-type">${alert.alert_type.replace('_', ' ').toUpperCase()}</span>
                                    <span class="alert-time">${new Date(alert.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="alert-message">${alert.message}</div>
                                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                    Camera: ${alert.camera_id} | Severity: ${alert.severity} | Score: ${alert.risk_score.toFixed(2)}
                                    ${alert.acknowledged ? ' | ‚úì Acknowledged' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    content.innerHTML = '<div class="loading">No alerts found</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading alerts: ${error.message}</div>`;
                console.error('Error loading alerts:', error);
            }
        }

        function addAlertToPanel(alert) {
            const content = document.getElementById('alertsContent');
            const alertClass = alert.severity.toLowerCase();
            const alertHTML = `
                <div class="alert-item ${alertClass}">
                    <div class="alert-header">
                        <span class="alert-type">${alert.alert_type.replace('_', ' ').toUpperCase()}</span>
                        <span class="alert-time">${new Date(alert.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                </div>
            `;
            content.insertAdjacentHTML('afterbegin', alertHTML);
            
            // Play sound for critical alerts
            if (alert.severity === 'CRITICAL') {
                playAlertSound();
            }
        }

        function playAlertSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        async function acknowledgeAlert(alertId) {
            const apiUrl = document.getElementById('apiUrl').value;
            try {
                const response = await fetch(`${apiUrl}/api/v1/alerts/${alertId}/acknowledge`, {
                    method: 'POST'
                });
                if (response.ok) {
                    loadAlerts();
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        function updateVideoStream() {
            if (!selectedCameraId) {
                document.getElementById('videoStream').style.display = 'none';
                document.getElementById('streamPlaceholder').style.display = 'block';
                return;
            }

            if (streamPaused) return;

            const apiUrl = document.getElementById('apiUrl').value;
            const showHeatmap = document.getElementById('showHeatmap')?.checked || false;
            const showZones = document.getElementById('showZones')?.checked !== false;
            const showTrackIds = document.getElementById('showTrackIds')?.checked !== false;
            
            const streamUrl = `${apiUrl}/stream/${selectedCameraId}?show_heatmap=${showHeatmap}&show_zones=${showZones}&show_track_ids=${showTrackIds}&show_metrics=true`;
            
            const img = document.getElementById('videoStream');
            const placeholder = document.getElementById('streamPlaceholder');
            
            img.src = streamUrl;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            
            img.onerror = () => {
                img.style.display = 'none';
                placeholder.style.display = 'block';
                placeholder.textContent = 'Stream unavailable';
            };
        }

        function updateStreamParams() {
            updateVideoStream();
        }

        function toggleStream() {
            streamPaused = !streamPaused;
            const btn = event.target;
            if (streamPaused) {
                btn.textContent = '‚ñ∂Ô∏è Play';
                document.getElementById('videoStream').src = '';
            } else {
                btn.textContent = '‚è∏Ô∏è Pause';
                updateVideoStream();
            }
        }

        function toggleFullscreen() {
            const container = document.getElementById('videoContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function captureSnapshot() {
            if (!selectedCameraId) return;
            const apiUrl = document.getElementById('apiUrl').value;
            const showHeatmap = document.getElementById('showHeatmap')?.checked || false;
            const showZones = document.getElementById('showZones')?.checked !== false;
            const showTrackIds = document.getElementById('showTrackIds')?.checked !== false;
            
            const snapshotUrl = `${apiUrl}/api/v1/cameras/${selectedCameraId}/snapshot?annotated=true&show_heatmap=${showHeatmap}&show_zones=${showZones}&show_track_ids=${showTrackIds}`;
            
            window.open(snapshotUrl, '_blank');
        }

        async function loadHistoricalAnalytics() {
            if (!selectedCameraId) {
                document.getElementById('analyticsTab').querySelector('.card').innerHTML = 
                    '<h2>üìà Historical Analytics</h2><div class="loading">Select a camera to view analytics</div>';
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - timeRangeHours * 60 * 60 * 1000);

            try {
                const response = await fetch(
                    `${apiUrl}/api/v1/analytics/${selectedCameraId}/history?` +
                    `start_time=${startTime.toISOString()}&end_time=${endTime.toISOString()}&interval=60`
                );
                const data = await response.json();

                // Create/update charts
                createChart('peopleCountChart', 'People Count Over Time', data, 'people_count', '#667eea');
                createChart('densityChart', 'Density Over Time', data, 'density', '#10b981');
                createChart('riskChart', 'Risk Score Over Time', data, 'risk_score', '#ef4444');
            } catch (error) {
                console.error('Error loading historical analytics:', error);
            }
        }

        function createChart(canvasId, title, data, field, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const labels = data.map(item => new Date(item.timestamp).toLocaleTimeString());
            const values = data.map(item => item[field] || 0);

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: values,
                        borderColor: color,
                        backgroundColor: color + '20',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadZones() {
            const cameraId = document.getElementById('zoneCameraSelect').value;
            if (!cameraId) {
                document.getElementById('zonesContent').innerHTML = 
                    '<div class="loading">Select a camera to manage zones</div>';
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            try {
                const response = await fetch(`${apiUrl}/api/v1/zones/${cameraId}`);
                const data = await response.json();

                if (data.zones && data.zones.length > 0) {
                    document.getElementById('zonesContent').innerHTML = data.zones.map(zone => `
                        <div class="zone-item">
                            <div>
                                <strong>${zone.zone_name}</strong> (${zone.zone_type})
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Occupancy: ${zone.current_occupancy || 0}${zone.max_capacity ? ` / ${zone.max_capacity}` : ''}
                                    | Status: ${zone.status}
                                </div>
                            </div>
                            <div>
                                <button onclick="editZone(${zone.id})">Edit</button>
                                <button onclick="deleteZone(${zone.id})" style="background: #ef4444; margin-left: 5px;">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('zonesContent').innerHTML = 
                        '<div class="loading">No zones configured for this camera</div>';
                }
            } catch (error) {
                document.getElementById('zonesContent').innerHTML = 
                    `<div class="error">Error loading zones: ${error.message}</div>`;
            }
        }

        function createZone() {
            editingZoneId = null;
            document.getElementById('zoneForm').reset();
            document.querySelector('#zoneModal h2').textContent = 'Create Zone';
            document.getElementById('zoneModal').classList.add('active');
        }

        function closeZoneModal() {
            editingZoneId = null;
            document.getElementById('zoneForm').reset();
            document.getElementById('zoneModal').classList.remove('active');
        }

        async function saveZone(event) {
            event.preventDefault();
            const cameraId = document.getElementById('zoneCameraSelect').value;
            if (!cameraId) {
                alert('Please select a camera first');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const zoneData = {
                camera_id: cameraId,
                zone_name: document.getElementById('zoneName').value,
                zone_type: document.getElementById('zoneType').value,
                max_capacity: document.getElementById('zoneCapacity').value ? parseInt(document.getElementById('zoneCapacity').value) : null,
                polygon_coords: [[0, 0], [100, 0], [100, 100], [0, 100]] // Placeholder - should be set via zone editor
            };

            try {
                let response;
                if (editingZoneId) {
                    // Update existing zone
                    response = await fetch(`${apiUrl}/api/v1/zones/${editingZoneId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(zoneData)
                    });
                } else {
                    // Create new zone
                    response = await fetch(`${apiUrl}/api/v1/zones`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(zoneData)
                    });
                }

                if (response.ok) {
                    closeZoneModal();
                    loadZones();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to ${editingZoneId ? 'update' : 'create'} zone: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error ${editingZoneId ? 'updating' : 'creating'} zone: ${error.message}`);
            }
        }

        let editingZoneId = null;

        async function editZone(zoneId) {
            editingZoneId = zoneId;
            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                // Get all zones to find the one we're editing
                const cameraId = document.getElementById('zoneCameraSelect').value;
                const response = await fetch(`${apiUrl}/api/v1/zones/${cameraId}`);
                const data = await response.json();
                
                const zone = data.zones.find(z => z.id === zoneId);
                if (!zone) {
                    alert('Zone not found');
                    return;
                }
                
                // Populate form with zone data
                document.getElementById('zoneName').value = zone.zone_name;
                document.getElementById('zoneType').value = zone.zone_type;
                document.getElementById('zoneCapacity').value = zone.max_capacity || '';
                
                // Update modal title
                document.querySelector('#zoneModal h2').textContent = 'Edit Zone';
                
                // Show modal
                document.getElementById('zoneModal').classList.add('active');
            } catch (error) {
                alert('Error loading zone: ' + error.message);
            }
        }

        async function deleteZone(zoneId) {
            if (!confirm('Are you sure you want to delete this zone?')) return;

            const apiUrl = document.getElementById('apiUrl').value;
            try {
                const response = await fetch(`${apiUrl}/api/v1/zones/${zoneId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadZones();
                } else {
                    const errorData = await response.json();
                    alert('Failed to delete zone: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting zone: ' + error.message);
            }
        }

        async function loadCrossCameraMovements() {
            const camera1 = document.getElementById('movementCamera1').value;
            const camera2 = document.getElementById('movementCamera2').value;
            const content = document.getElementById('movementsContent');

            if (!camera1 && !camera2) {
                content.innerHTML = '<div class="loading">Select cameras to view movements</div>';
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            try {
                let url = `${apiUrl}/api/v1/movements?limit=50`;
                if (camera1) url += `&entry_camera_id=${camera1}`;
                if (camera2) url += `&exit_camera_id=${camera2}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    content.innerHTML = data.map(movement => `
                        <div class="movement-item">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${movement.entry_camera_id} ‚Üí ${movement.exit_camera_id}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                Track ${movement.entry_track_id} ‚Üí Track ${movement.exit_track_id} | 
                                Duration: ${movement.duration_seconds.toFixed(1)}s | 
                                Similarity: ${(movement.similarity_score * 100).toFixed(1)}% 
                                (${movement.match_confidence})
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                ${new Date(movement.entry_timestamp).toLocaleString()} ‚Üí 
                                ${new Date(movement.exit_timestamp).toLocaleString()}
                            </div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="loading">No cross-camera movements found</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading movements: ${error.message}</div>`;
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                stopAutoRefresh();
                btn.textContent = 'Start Auto-Refresh';
                btn.classList.remove('active');
            } else {
                startAutoRefresh();
                btn.textContent = 'Stop Auto-Refresh';
                btn.classList.add('active');
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) return;

            autoRefreshInterval = setInterval(() => {
                if (selectedCameraId) {
                    loadMetrics();
                    loadDetection();
                    loadEntryExit();
                    if (currentTab !== 'alerts') {
                        loadAlerts();
                    }
                } else {
                    loadCameras();
                }
            }, 2000);

            updateLastUpdateTime();
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${now.toLocaleTimeString()}`;
        }

        // Initialize camera selects
        document.getElementById('zoneCameraSelect').addEventListener('change', loadZones);
        document.getElementById('movementCamera1').addEventListener('change', () => {
            loadCameras().then(() => {
                document.getElementById('movementCamera1').value = event.target.value;
            });
        });
        document.getElementById('movementCamera2').addEventListener('change', () => {
            loadCameras().then(() => {
                document.getElementById('movementCamera2').value = event.target.value;
            });
        });

        // Close modal on outside click
        document.getElementById('zoneModal').addEventListener('click', (e) => {
            if (e.target.id === 'zoneModal') {
                closeZoneModal();
            }
        });
    </script>
</body>
</html>
